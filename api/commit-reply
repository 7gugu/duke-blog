#!/usr/local/bin/haserl
Content-Type: application/json

<%

set -e
source "$(dirname "${BASH_SOURCE[0]}")/tools/common"

url="$GET_url$POST_url"
email="$GET_email$POST_email"
password="$GET_password$POST_password"
id="$GET_id$POST_id"

[[ "$email" != "" ]] && { ./tools/auth "$email" "$password" || exit 1; }

db_top="$(busybox realpath "$(dirname "${BASH_SOURCE[0]}")/../db")"
accounts_top="$db_top/accounts"
article_dir="$db_top/articles/$url/_content"
reply_dir="$db_top/articles/$url/comments/$id"

[[ "$url" == "" ]] && { echo 'url not specified'; exit 1; }
[[ ! -d "$reply_dir" ]] && { echo 'reply folder not found'; exit 1; }

#default "dflt" if no email specified
permissions=$(git config --file="$accounts_top/$email" base.permissions || echo "dflt")
attributes=$(git config --file="$article_dir/metadata" base.attributes)
check_attribute_overlap "$permissions" "$attributes" || { echo 'permission denied'; exit 1; }

#if new reply
if [[ "$id" == "" ]]; then
 #id=max+1
fi

exit 0

%>
