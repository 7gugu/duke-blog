#!/usr/local/bin/haserl
Content-Type: application/json

<%

set -e

user="$GET_user$POST_user"
password="$GET_password$POST_password"
start="$GET_start$POST_start"
count="$GET_count$POST_count"
filters="$GET_filters$POST_filters"
filters=(${filters//,/ }) #convert to array

[[ "$user" != "" ]] && { ./tools/auth "$user" "$password" || exit 1; }

[[ "$start" == "" ]] && start="0"
[[ "$count" == "" ]] && count="20"
((start < 0 || start > 100)) && start="0"
((count < 0 || count > 100)) && count="100"

#default "dflt" if no user specified
permissions=$(git config --file="$accounts_top/$user" base.permissions || echo "dflt")
permissions=(${permissions//,/ })

db_top="$(busybox realpath "$(dirname "${BASH_SOURCE[0]}")/../db")"
accounts_top="$db_top/accounts"
articles_top="$db_top/articles"

index="$(tac "$articles_top/index")"

for i in "${!filters[@]}"; do
  index="$(echo "$index" | awk "$(echo "\$2 ~ \"${filters[i]}\"")" )"
done

for i in "${!permissions[@]}"; do
  p="P_${permissions[i]}"
  index="$(echo "$index" | awk "$(echo "\$2 ~ \"$p\"")" )"
done

total="$(echo "$index" | wc -l)"
((start > total)) && start=$((total))
((count > total - start)) && count=$((total - start))

index="$(echo "$index" | head -n $((start+count)) | tail -n $count)"

echo -n '{"articles":['
virgin="true"
while read -r line; do
  [[ "$line" == "" ]] && break #avoid "$index" empty issue
  [[ "$virgin" == "true" ]] && virgin="false" || echo ","
  ./tools/json-article "${line% *}"
done <<< "$index"

echo '],'
echo '"status":"success"}'
exit 0

%>
