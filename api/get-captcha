#!/usr/local/bin/haserl
Content-Type: application/json

<%

set -e

config_file="$(busybox realpath "$(dirname "${BASH_SOURCE[0]}")/../config.ini")"
captcha_length=$(git config --file="$config_file" captcha.length)

date=$(date --iso-8601=seconds)
string=$(tr -dc A-Za-z0-9 2>/dev/null < /dev/urandom | head -c $captcha_length) #avoid stderr Broken pipe message
[[ "${#string}" != "$captcha_length" ]] && exit 1

base64_img=$(./tools/base64-captcha $string)
string=${string,,} #to lowercase; ${string^^} for uppercase

touch ".cache/captcha/$date-$string" # restore by: ${filename%-*} and ${filename##*-}

echo "{\"date\":\"$date\","
echo "\"image\":\"$base64_img\","
echo "\"status\":\"success\"}"
exit 0

%>
