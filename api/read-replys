#!/usr/local/bin/haserl
Content-Type: application/json

<%

set -e

url="$GET_url"
email="$GET_email"
password="$GET_password"
start="$GET_start"
count="$GET_count"

[[ "$email" != "" ]] && { ./tools/auth "$email" "$password" || exit 1; }

[[ "$start" == "" ]] && start="0"
[[ "$count" == "" ]] && count="20"
((start < 0 || start > 100)) && start="0"
((count < 0 || count > 100)) && count="100"

db_top="$(busybox realpath "$(dirname "${BASH_SOURCE[0]}")/../db")"
accounts_top="$db_top/accounts"
article_dir="$db_top/articles/$url/_content"
reply_top="$db_top/articles/$url/comments"

[[ "$url" == "" ]] && { echo '{"error":"no url specified"}'; exit 1; }
[[ ! -d "$reply_top" ]] && { echo '{"error":"reply folder not found"}'; exit 1; }

permissions=$(git config --file="$accounts_top/$email" base.permissions || echo "dflt")
permissions=(${permissions//,/ })

attributes=$(git config --file="$article_dir/metadata" base.attributes)

have_permission="false"

for i in "${!permissions[@]}"; do
  p="P_${permissions[i]}"
  [[ "$attributes" =~ "$p" ]] && { have_permission="true"; break; }
done

[[ "$have_permission" != "true" ]] && { echo '{"error":"permission denide"}'; exit 1; }

total="$(ls -1 $reply_top | wc -l)"
((start > total)) && start=$((total))
((count > total - start)) && count=$((total - start))

index=($(ls "$reply_top" | head -n $((start+count)) | tail -n $count))

echo -n "["
for i in "${!index[@]}"; do
  ./tools/json-reply "$url" "${index[i]}"
  [[ $((i+1)) != ${#index[@]} ]] && echo ","
done
echo "]"

exit 0

%>

